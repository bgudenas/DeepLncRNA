---
title: "Differential_transcrip_expr"
author: "Brian Gudenas"
date: "August 18, 2017"
output: html_document
fig_width: 8
fig_height: 6
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, cache.lazy = FALSE, warning = FALSE)
opts_knit$set(root.dir = "C:/Users/Brian/Documents/Localization")
```


```{r DL_Libraries, eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite("rhdf5")
devtools::install_github("pachterlab/sleuth")
```

```{r Libraries}
library(readr)
library(stringr)
library(sleuth)
library(dplyr)
library(ggplot2)
```


```{r Metadata}
## load Metadata and convert Salmon output for use in Sleuth using wasabi::prepare_fish_for_sleuth
samples = read_tsv("./Data/Meta/metadata.tsv")
colnames(samples) = make.names(colnames(samples))
Pair = read.table("./Data/Meta/Pair_map.txt", sep="\t", header = TRUE)

samples = samples[!is.na(match(samples$File.accession, Pair$Pair1)), ]

samples = samples[samples$Biosample.subcellular.fraction.term.name == "nucleus" | samples$Biosample.subcellular.fraction.term.name == "cytosol", ]

files = file.path(getwd(), "Data/Results", samples$File.accession)


```

```{r Sleuth, cache = TRUE}

samples$Library.depleted.in[is.na(samples$Library.depleted.in)] = "rRNA"
samples$Lib_method = paste0(samples$Library.made.from, samples$Library.depleted.in)
s2c = dplyr::select(samples, sample = File.accession, condition = Biosample.subcellular.fraction.term.name, cell = Biosample.term.name, platform = Platform, Lib = Lib_method, reads = Read.length, warning = Audit.WARNING)

s2c = dplyr::mutate(s2c, path = files)

#s2c = filter(s2c ,  !grepl("low", samples$Audit.WARNING) )

RNA = dplyr::filter(s2c, Lib == "RNArRNA")
polyA = dplyr::filter(s2c, Lib == "polyadenylated mRNArRNA")
nopolyA = dplyr::filter(s2c, Lib == "RNArRNA, polyadenylated mRNA")


so_RNA = sleuth_prep(RNA, extra_bootstrap_summary = TRUE)
so_polyA = sleuth_prep(polyA, extra_bootstrap_summary = TRUE)
so_nopolyA = sleuth_prep(nopolyA, extra_bootstrap_summary = TRUE)
save.image("./Data/DTE.RData")

```

```{r DTE}
plot_pca(so_nopolyA, color_by = "cell",  text_labels = TRUE) +ggtitle("Minus Poly A")
plot_pca(so_RNA, color_by = "cell", text_labels = TRUE) +ggtitle("Total RNA")
plot_pca(so_polyA, color_by = "cell",  text_labels = TRUE) +ggtitle("Poly A")
```

Appears to be two possible outliers in the Poly A samples (ENCFF901DUO, ENCFF792JEE) driving large variance in PC1. 
Upon inspection these samples contain audit warnings for "low read depth" so we will remove them 

```{r}
dplyr::filter(polyA, sample == "ENCFF901DUO" | sample == "ENCFF792JEE")
```


```{r, New_polyA, cache=TRUE}
polyA = dplyr::filter(polyA, sample != "ENCFF901DUO" & sample != "ENCFF792JEE")
so_polyA = sleuth_prep(polyA, extra_bootstrap_summary = TRUE)
plot_pca(so_polyA, color_by = "cell", text_labels = TRUE) +ggtitle("Poly A")

nRNA = nrow(RNA)
npolyA = nrow(polyA)
nnopolyA = nrow(nopolyA)

save.image("./Data/DTE.RData")

```

Now we will perform differential expression analysis for each RNA-seq dataset. Multiple testing adjustments are already performed within each DE test therefore we will only adjust the overall FDR-threshold since 3 tests  are being performed. Therefore we selected the FDR threshold of 0.01 (0.01 < (0.05/3) )

```{r Model_nopolyA}

so_nopolyA <- sleuth_fit(so_nopolyA, ~cell + condition, 'full')
so_nopolyA <- sleuth_fit(so_nopolyA, ~cell, 'reduced')
so_nopolyA <- sleuth_lrt(so_nopolyA, 'reduced', 'full')
so_nopolyA = sleuth_wt(so_nopolyA, "conditionnucleus")
wt_results = sleuth_results(so_nopolyA, 'conditionnucleus')
lrt_results = sleuth_results(so_nopolyA, "reduced:full", "lrt")
res = merge(lrt_results, wt_results[ , c("target_id", "b", "se_b", "mean_obs")], on = "target_id", sort = FALSE)
res$target_id = unlist(lapply(str_split(res$target_id, "\\."), "[[", 1))
out_name = paste0("./Data/tables/DTE_nopolyA","_","condition_nucleus", ".tsv")
res = res[!is.na(res$qval), ]
res = res[res$qval <= 0.01, ]
write.table(res, out_name, sep = "\t", quote = FALSE, row.names = FALSE)

```

```{r Model_RNA}

so_RNA <- sleuth_fit(so_RNA, ~cell + condition, 'full')
so_RNA <- sleuth_fit(so_RNA, ~cell, 'reduced')
so_RNA <- sleuth_lrt(so_RNA, 'reduced', 'full')
so_RNA = sleuth_wt(so_RNA, "conditionnucleus")
wt_results = sleuth_results(so_RNA, 'conditionnucleus')
lrt_results = sleuth_results(so_RNA, "reduced:full", "lrt")
res = merge(lrt_results, wt_results[ , c("target_id", "b", "se_b", "mean_obs")], on = "target_id", sort = FALSE)
res$target_id = unlist(lapply(str_split(res$target_id, "\\."), "[[", 1))
out_name = paste0("./Data/tables/DTE_RNA","_","condition_nucleus", ".tsv")
res = res[!is.na(res$qval), ]
res = res[res$qval <= 0.01, ]
write.table(res, out_name, sep = "\t", quote = FALSE, row.names = FALSE)

```

```{r Model_polyA}
# add in platform covariate since polyA samples were run on genome analyzer or hiseq
so_polyA <- sleuth_fit(so_polyA, ~cell + platform + condition, 'full')
so_polyA <- sleuth_fit(so_polyA, ~cell + platform, 'reduced')
so_polyA <- sleuth_lrt(so_polyA, 'reduced', 'full')
so_polyA = sleuth_wt(so_polyA, "conditionnucleus")
wt_results = sleuth_results(so_polyA, 'conditionnucleus')
lrt_results = sleuth_results(so_polyA, "reduced:full", "lrt")
res = merge(lrt_results, wt_results[ , c("target_id", "b", "se_b", "mean_obs")], on = "target_id", sort = FALSE)
res$target_id = unlist(lapply(str_split(res$target_id, "\\."), "[[", 1))
out_name = paste0("./Data/tables/DTE_polyA","_","condition_nucleus", ".tsv")
res = res[!is.na(res$qval), ]
res = res[res$qval <= 0.01, ]
write.table(res, out_name, sep = "\t", quote = FALSE, row.names = FALSE)

```

```{r Merge_results, eval = FALSE}
  polyA = read_tsv("./Data/tables/DTE_polyA_condition_nucleus.tsv") %>% 
          filter(qval < 0.01)
  nopolyA = read_tsv("./Data/tables/DTE_nopolyA_condition_nucleus.tsv") %>% 
          filter(qval < 0.01)
  RNA = read_tsv("./Data/tables/DTE_RNA_condition_nucleus.tsv") %>% 
          filter(qval < 0.01)
  
  df = as.data.frame(rbind(cbind(polyA$target_id, polyA$b, "polyA"),
            cbind(nopolyA$target_id, nopolyA$b, "nopolyA"),
            cbind(RNA$target_id, RNA$b, "RNA")))
  colnames(df) = c("target_id","b","type")
  df$b = as.numeric(as.character(df$b))
  
  nTotal =  94 # total number of samples
  #  set weights for each dataset to integrate the log fold-change estimates from the 3 DE tests
  df$wt = npolyA
  df$wt[df$type == "nopolyA"] = nnopolyA
  df$wt[df$type == "RNA"] = nRNA
  df$target_id = as.character(df$target_id)
  
  
  joined_df = matrix(nrow=length(unique(df$target_id)), ncol = 1)
  rownames(joined_df) = unique(df$target_id)
  colnames(joined_df) = "b"
  for (i in rownames(joined_df)) {
    trans = df[df$target_id == i, ]
    wt_sum = sum(trans$b *trans$wt)/sum(trans$wt)
    joined_df[ rownames(joined_df) == i, 1] = wt_sum
  }
  
joined_df = as.data.frame(joined_df)
```

```{r, LncRNA_test, eval = FALSE}
mart = useMart("ensembl", dataset = "hsapiens_gene_ensembl")
map = getBM(mart = mart, attributes = c("ensembl_transcript_id","gene_biotype", "transcript_length","percentage_gene_gc_content", "transcript_count"),
            filters = "ensembl_transcript_id", values=rownames(joined_df))


lncRNA_filter = c("3prime_overlapping_ncrna", "antisense","antisense_RNA", "lincRNA","ncrna_host","processed_transcript", "sense_intronic" , "sense_overlapping", "bidirectional_lncRNA", "non_coding", "macro_lncRNA")

lnc_test=c()
for (biotype in map$gene_biotype) {
    lnc_test =c(lnc_test, (sum(grepl(biotype, lncRNA_filter)) > 0 ) )
}
mat = match(rownames(joined_df), map$ensembl_transcript_id)


joined_df$lncRNA = lnc_test[mat]
joined_df$gene_biotype = map$gene_biotype[mat]
joined_df$transcript_length = map$transcript_length[mat]
joined_df$percentage_gene_gc_content = map$percentage_gene_gc_content[mat]


lncRNAs = joined_df[joined_df$lncRNA == TRUE, ]
lncRNAs = lncRNAs[!is.na(lncRNAs$b), ]

seq = getSequence(id = rownames(lncRNAs), type="ensembl_transcript_id", seqType = "cdna", mart = mart)
lncRNAs$cdna = seq$cdna[match(rownames(lncRNAs), seq$ensembl_transcript_id)]
lncRNAs = lncRNAs[, -2]

saveRDS(lncRNAs, "./Data/DE_lncRNAs.rds")
```

```{r, genome_lncRNAs, cache = TRUE}
library(seqinr)
library(stringr)
library(biomaRt)

ncRNA = read.fasta("./Data/Homo_sapiens.GRCh38.ncrna.fa")
Annot = getAnnot.list(ncRNA)

out =c()

for (i in Annot){
  ID = strsplit(i[1][[1]], split = "\\.")[[1]][1]
  ID = str_sub(ID, 2, nchar(ID))
  biotype = strsplit(i[1][[1]], split = "transcript_biotype:")[[1]][2]
  biotype = strsplit(biotype, "gene_symbol:")[[1]][1]
  biotype = str_trim(biotype)
  
  lncRNA_filter = c("3prime_overlapping_ncrna", "antisense","antisense_RNA", "lincRNA","ncrna_host","processed_transcript", "sense_intronic" , "sense_overlapping", "bidirectional_lncRNA", "non_coding", "macro_lncRNA")
  
  if (biotype %in% lncRNA_filter){
    out =c(out, ID)
  }
}

mart = useMart("ensembl", dataset = "hsapiens_gene_ensembl")
map = getBM(mart = mart, attributes = c("ensembl_transcript_id","gene_biotype","transcript_length","percentage_gene_gc_content", "transcript_count"),
            filters = "ensembl_transcript_id", values = out)

seq = getSequence(id = map$ensembl_transcript_id, type="ensembl_transcript_id", seqType = "cdna", mart = mart)

map$cdna = seq$cdna[match(map$ensembl_transcript_id, seq$ensembl_transcript_id)]
saveRDS(map, "./Data/genomic_lncRNAs.rds")

```

```{r Kmer_add}
# this function takes a df of transcripts (containing a "cdna" column of the sequence) and integer of K for which it calculates
# k-mer frequency features from 4:K and appends these columns to df

Kmer_add = function(df, k){
  #df must contain "cdna" column
  #k is largest int of 
  kmer_mat = matrix( ncol = sum(4^seq(4, k)) , nrow = nrow(df), data =0)
  
  for (i in 1:nrow(df)){
    seq =DNAString(df$cdna[i])
    len = df$transcript_length[i]
    index = 0
    for (j in 4:k) {
    kmers = oligonucleotideFrequency(seq, j)
    ind2 = index
    if (j == 1){ ind2 = 0}
    
    kmer_mat[i, (index + 1): (ind2 + (4^j) ) ] = as.vector(kmers)/len
    index = index + (4^j)
    }
  }
  
  nams =c()
  for (i in 4:k){
    nams =c(nams, names(oligonucleotideFrequency(seq, i)) )
  
  }
  colnames(kmer_mat) = nams
  df = cbind(df, kmer_mat)
  return(df)
}

# Create function which filters K-mers using t.test between Nuclear and Cytosolic transcripts
Kmer_filt = function(df){
  library(broom)  
  
  test_vals =c()
  Nuclear = df$b > 1
  Cyto = df$b < 0
  
  for ( i in 6:ncol(df)) {
    vals = tidy(t.test(df[Nuclear, i], df[Cyto, i] ) )
    test_vals = c(test_vals, vals$p.value )
  }
  names(test_vals) = colnames(df[6:ncol(df)])
    
  
  test_vals = p.adjust(test_vals, method = "fdr")
  filt = which(test_vals < 0.01)
  
  filt = c(1:5, filt+5)
  
  return(filt)
  
}


Supervised = Kmer_add(lncRNAs, k = 7)
filt = Kmer_filt(Supervised)
Supervised = Supervised[ , filt]

genome = genome[is.na(match(genome$ensembl_transcript_id, rownames(lncRNAs)) ),  ]
Unsupervised = Kmer_add(genome, k = 7)
Unsupervised = Unsupervised[ , filt]
saveRDS(Unsupervised, "./Data/Unsupervised_df.rds")
```

```{r}
Supervised = Supervised[ , -5]
Supervised$gene_biotype = as.factor(Supervised$gene_biotype)

inTrain = sample(1:nrow(Supervised), .7*nrow(Supervised))
train = Supervised[inTrain, ]
test = Supervised[-inTrain, ]

library(randomForest)
rf = randomForest(data = train,
                  b ~ .,
                  ntree = 1000)


test_vals = predict(rf, test)
cor.test(test_vals, test$b)
sqrt(mean((test_vals - test$b)^2))

```





